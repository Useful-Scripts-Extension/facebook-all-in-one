import{r as x,ar as e,au as $}from"./index-Cmqd91YY.js";import{u as Ve,a as Re}from"./index-A0fhuegc.js";import{f as Oe}from"./file-download-D1YJKzn9.js";import{u as We,c as qe,d as S,t as xe,w as ze,af as me,b as A,T as je,ag as Ge,S as z,i as Je,ah as Xe,ai as Qe,aj as Ye}from"./MyApp-DRRPEL9l.js";import{D as Ze}from"./index-BjbB-wWo.js";import{C as Ue}from"./index-CUB3rmyf.js";import{I as Ke}from"./index-CgW1d8K7.js";import{L as Ne}from"./index-DZo1b7iv.js";import{D as et}from"./index-B3xfp5TG.js";function tt(i,G,I){const[u,m]=x.useState(!1);function L({key:j}){j===i&&m(!0)}function F({key:j}){j===i&&(m(!1),I==null||I())}return x.useEffect(()=>(window.addEventListener("keydown",L),window.addEventListener("keyup",F),()=>{window.removeEventListener("keydown",L),window.removeEventListener("keyup",F)}),[]),u}var ye=(i=>(i.File="file",i.Link="link",i.JSON="json",i))(ye||{}),nt=(i=>(i.Grid="grid",i.Vertical="vertical",i))(nt||{});function gt({collectionName:i,renderItem:G,fetchNext:I,rowKey:u,downloadItem:m,getItemCursor:L,initialData:F=[],downloadThreads:j=5,displayType:be="grid",headerButtons:J=()=>null,header:X=()=>null,once:De=!1,all:ke=!1,stop:Ce=!1,showPagination:ne=!1,pageSize:$e=20,searchPlaceholder:Se=()=>({en:"Search",vi:"Tìm kiếm"}),onSearch:T}){const{ti:t}=We(),{message:y,notification:H}=qe(),{isIntersecting:Ie,ref:Le}=Ve(),[ie,oe]=x.useState(!1),[Pe,le]=S(`Collection.${i}.hasMore`,!0),[s,se]=S(`Collection.${i}.data`,F),[ae,Be]=S(`Collection.${i}.pageIndex`,1),[B,Ee]=S(`Collection.${i}.search`,""),[a,V]=S(`Collection.${i}.selected`,[]),[h,re]=S(`Collection.${i}.selectMode`,!1),[Me,_e]=S(`Collection.${i}.downloaded`,{});tt("Shift",void 0,()=>{m&&re(n=>!n)});const Ae=x.useMemo(()=>!B||!T?s:s.filter(n=>T(B,n)),[s,B,T]);x.useEffect(()=>{let n=s.length,o=Math.ceil(n/20);ae>o&&Be(o)},[s,ae]),x.useEffect(()=>{s.length||de(!1)},[i]);const R=(!s.length||Ie||ke)&&Pe&&!B&&!Ce;Re(()=>{R&&Y()},1e3),x.useEffect(()=>{R&&Y()},[R]);const de=(n=!1)=>{n&&xe("Collection:reload");const o=n?[]:ze("Collection.data."+i)||[];se(o),Y(o)},Q=x.useRef(!1),Y=async(n=s)=>{if(Q.current)return;Q.current=!0,oe(!0);const o=await I(n);if(console.log(i,o),o!=null&&o.length){const r=me(n,o,u);if(le(!De&&r.length>0),r.length){const b=[...n,...r];se(b)}}else(o==null?void 0:o.length)===0&&le(!1);Q.current=!1,oe(!1)},Fe=(n,o)=>{const r=a.indexOf(n),b=r>=0,v=Me[u(n)],E={position:"absolute",top:0,left:0,right:0,bottom:0,width:"100%",height:"100%",background:b||v?"#000a":"#0002"};return e.jsxs("div",{style:{position:"relative",flexGrow:1,height:"100%"},children:[o<s.length-1?G(n,o):e.jsx(A,{ref:Le,children:G(n,o)}),h?e.jsx($,{type:"primary",style:E,className:"scale-on-hover",onClick:()=>{V(b?D=>D.filter(O=>O!==n):D=>[...D,n])},children:b?e.jsx("i",{className:"fa-solid fa-5x",children:r+1}):v?e.jsx("i",{className:"fa-solid fa-check fa-5x"}):e.jsx("i",{className:"fa-solid fa-square  fa-5x",style:{color:"#fff7"}})}):v?e.jsx("div",{style:{...E,display:"flex",justifyContent:"center",alignItems:"center",pointerEvents:"none",background:"#0006"},children:e.jsx("i",{className:"fa-solid fa-check fa-5x",style:{color:"white"}})}):null]},"select_container_"+u(n))},ce=async({fromCursor:n,downloadType:o,startIndex:r=0}={})=>{var we;if(!m)return;const b=await Ge();if(!("showDirectoryPicker"in window)&&o==="file")return z.fire({icon:"error",title:t({en:"Browser not supported",vi:"Trình duyệt không hỗ trợ"}),text:t({en:"File saver API not supported in this browser. Please use newest version of Edge or Chrome. (window.showDirectoryPicker)",vi:"Trình duyệt này không hỗ trợ API lưu file (window.showDirectoryPicker). Vui lòng sử dụng Edge hoặc Chrome bản mới nhất"})});let v;if(!n&&!h&&(v=await z.fire({icon:"question",title:t({en:"Download",vi:"Tải xuống"})+"?",text:i,showDenyButton:!0,showCancelButton:!1,confirmButtonColor:"#d33",denyButtonColor:"#1668dc",confirmButtonText:t({en:"Download from cursor",vi:"Tiếp tục tải"}),denyButtonText:t({en:"Download all",vi:"Tải từ đầu"})}),v.isDismissed))return;if(v!=null&&v.isConfirmed){const l=await z.fire({icon:"info",title:t({en:"Download from cursor",vi:"Tiếp tục tải"}),html:`
                <label for="from-cursor">
                ${t({en:"Last cursor",vi:"Con trỏ cuối"})}: (${t({en:"leave empty to re-download all",vi:"bỏ trống để tải từ đầu"})})
                </label><br/>
                <input
                    id="from-cursor"
                    class="swal2-input"
                    style="margin: 5px"
                    value="${n||localStorage.getItem(i+"_fromCursor")||""}">
                <br/>
                <label for="start-index">
                ${t({en:"Last index",vi:"Vị trí cuối"})}: (${t({en:"for auto generate file name",vi:"để tự động tạo tên file"})})
                </label><br/>
                <input
                    id="start-index"
                    class="swal2-input"
                    style="margin: 5px"
                    value="${r||localStorage.getItem(i+"_startIndex")||0}">
            `,preConfirm:()=>{var c,_;return[(c=document.getElementById("from-cursor"))==null?void 0:c.value,(_=document.getElementById("start-index"))==null?void 0:_.value]},showCancelButton:!0,confirmButtonText:t({en:"Start download",vi:"Bắt đầu tải"})});if(l.isDismissed||l.isDenied)return;n=l.value[0],r=parseInt(((we=l.value)==null?void 0:we[1])||0)}if(!o){const l=await z.fire({icon:"question",title:t({en:"Data type",vi:"Loại dữ liệu"}),html:`
                    <label for="download-type">
                        ${t({en:"Which data type you want to download?",vi:"Bạn muốn tải xuống loại dữ liệu nào?"})}
                    </label><br/>
                    <select
                        id="download-type"
                        class="swal2-select"
                        style="margin: 5px">
                        ${Object.values(ye).map(c=>`<option value="${c}">${c}</option>`).join("")}
                    </select>
                `,preConfirm:()=>{var c;return(c=document.getElementById("download-type"))==null?void 0:c.value},showCancelButton:!0,reverseButtons:!0});if(l.isDismissed)return;o=l.value}if(!await Je())return;xe("downloadCollection:"+o+":"+(h?`selected:${a.length}:`:"all:")+i);let E;if(o==="file"){const l=await window.showDirectoryPicker({mode:"readwrite"});await l.requestPermission({writable:!0}),E=await l.getDirectoryHandle(i,{create:!0})}const D="downloading_collection_"+i,O="stopping_downloading_collection_"+i;y.loading({key:D,content:t({en:"Downloading",vi:"Đang tải"})+"...",duration:0});const k=n?[]:h?[...a]:[...s];let Z=0,U=0,W=0,M=0,g=0,K=!0,p=!1,fe=!1,ue=!0,he=[],ge=[];for(;!p&&ue;){if(!h&&g>=k.length-j-1){const P=await I(k,K?n:void 0),d=me(k,P,u);!(d!=null&&d.length)&&K&&n&&H.open({type:"error",message:t({en:"No data at from your cursor",vi:"Không có dữ liệu tại vị trí bạn nhập"})+n+" ("+i+")",description:t({en:"Will download from start",vi:"Sẽ tải từ đầu"}),duration:0}),K=!1,console.log(d),d!=null&&d.length?k.push(...d):ue=!1}const l=k.slice(g,g+j);if(!l.length)break;const c=Math.min(j,l.length),_=Array.from({length:c},()=>"");await Promise.all(l.map(async(P,d)=>{try{let f=await m(P,Z);Array.isArray(f)||(f=[f]);let ve=!1;for(let w=0;w<f.length&&!p;w++){const{url:C,name:He}=f[w];if(!C)continue;const N=r+g+d+"_"+w+"_"+He;if(f[w].name=N,_[d]="thread "+(d+1)+": item "+(Z+d+1)+(f.length>1?` (${w+1}/${f.length})`:""),!p&&!fe&&y.loading({key:D,content:e.jsxs("span",{children:[`${t({en:"Downloading",vi:"Đang tải"})}... ${U}`,W?e.jsxs(e.Fragment,{children:[t({en:"Failed",vi:"Lỗi"}),": $",W," ",e.jsx("br",{})]}):"",e.jsx("br",{}),i,e.jsx("br",{}),e.jsx("i",{children:t({en:"Click to stop",vi:"Bấm để dừng"})}),e.jsx("br",{}),e.jsx(et,{}),_.map((ee,te)=>e.jsxs("span",{style:{width:"100%",textAlign:"left",display:"block"},children:[ee,e.jsx("br",{})]},te)),e.jsx("br",{})]}),duration:0,onClick:()=>{p=!0,y.loading({key:O,content:t({en:"Stopping...",vi:"Đang dừng..."}),duration:0})}}),ge.push(C),o==="file")try{const te=await(await Xe({url:C,checkAbortFn:()=>p})).blob(),pe=await(await E.getFileHandle(N,{create:!0})).createWritable();await pe.write(te),await pe.close()}catch{p||(b?(await Qe({url:C,conflictAction:"overwrite",filename:i+"/"+N}),ve=!0):(W++,H.open({type:"error",message:t({en:"Download failed",vi:"Lỗi tải"}),description:C})))}U++}ve&&M++,Z++,he.push({data:f,raw:P}),_e(w=>({...w,[u(P)]:!0})),V(w=>w.filter(C=>u(C)!==u(P)))}catch(f){W++,y.error({content:t({en:"Download failed",vi:"Lỗi tải"})+": "+f.message})}})),p||(g+=l.length)}if(fe=!0,o==="json"||o==="link"){const l=i+(o==="json"?".json":".txt"),c=o==="json"?JSON.stringify(he,null,4):ge.join(`
`);Oe(c,l)}let q="";try{q=(L==null?void 0:L(k[g]||k[g-1]))||""}catch(l){console.error(l)}y.destroy(D),y.destroy(O),M>0&&H.open({type:"info",message:t({en:"In Download/ folder",vi:"Trong folder Download/"})+": "+M,description:t({en:"Files that cannot be normal downloaded, will be force download into default Download folder of your browser",vi:"Những file không thể tải bình thường, sẽ được tải vào trong folder Download/ mặc định của trình duyệt"}),duration:0,btn:e.jsx($,{onClick:Ye,children:t({en:"Show Download/ folder",vi:"Mở folder Download/"})})}),H.open({type:"success",message:t(p?{en:"Download stopped",vi:"Đã dừng tải"}:{en:"Download finished",vi:"Tải xong"}),description:e.jsxs("ul",{children:[e.jsx("li",{children:t({en:"Folder name",vi:"Tên folder"})+": "+i}),e.jsx("li",{children:t({en:"Downloaded",vi:"Đã tải"})+": "+U}),M>0&&e.jsx("li",{children:t({en:"In Download/ folder",vi:"Trong folder Download/"})+": "+M}),e.jsx("li",{children:t({en:"Last index",vi:"Vị trí cuối"})+": "+(g+r)}),e.jsx("li",{children:t({en:"Last cursor",vi:"Con trỏ cuối"})+": "+q})]}),duration:0,btn:e.jsx(A,{direction:"horizontal",children:p&&!h?e.jsx($,{onClick:()=>ce({downloadType:o,fromCursor:q,startIndex:g+r}),children:t({en:"Continue download",vi:"Tiếp tục tải"})}):null})}),localStorage.setItem(i+"_fromCursor",q+""),localStorage.setItem(i+"_startIndex",g+r+"")},Te=m&&s.length>0;return e.jsxs(A,{direction:"vertical",align:"center",style:{width:"100%"},children:[X==null?void 0:X(s),e.jsxs($.Group,{style:{width:"100%",justifyContent:"center"},children:[e.jsx($,{onClick:()=>de(!0),icon:e.jsx("i",{className:"fa-solid fa-rotate-right"}),disabled:ie,loading:ie,children:t({en:"Refresh",vi:"Làm mới"})}),Te&&e.jsx(Ze,{menu:{items:[{key:"selectMode",label:e.jsxs(A,{align:"center",children:[e.jsxs(je,{title:t({en:"Shortcut: press Shift",vi:"Phím tắt: ấn Shift"}),children:[e.jsx(Ue,{checked:h})," ",t({en:"Select mode",vi:"Chọn để tải"})]}),(a==null?void 0:a.length)>0&&e.jsx(je,{title:t({en:"Clear selected",vi:"Xoá lựa chọn"}),children:e.jsx($,{onClick:n=>{n.preventDefault(),n.stopPropagation(),V([])},icon:e.jsx("i",{className:"fa-solid fa-trash"}),children:a==null?void 0:a.length})})]})},{key:"file",label:t({en:"Download files",vi:"Tải files"})},{key:"link",label:t({en:"Download links",vi:"Tải links"})},{key:"json",label:t({en:"Download .json",vi:"Tải .json"})}],onClick:n=>{n.key==="selectMode"?re(!h):!h||(a==null?void 0:a.length)>0?ce({downloadType:n.key}):y.info(t({en:"Please select media to download",vi:"Vui lòng chọn ảnh/video muốn tải"}))}},children:e.jsx($,{type:"primary",icon:e.jsx("i",{className:"fa-solid fa-download"}),children:h?a.length?t({en:"Download",vi:"Tải xuống"})+` (${a.length})`:t({en:"Select to download...",vi:"Chọn để tải..."}):t({en:"Download all",vi:"Tải xuống tất cả"})})}),J==null?void 0:J(s)]}),T&&e.jsx(Ke.Search,{value:B,onChange:n=>Ee(n.target.value+""),placeholder:t(Se(s)),allowClear:!0,style:{minWidth:300}}),e.jsx(Ne,{grid:{gutter:10,column:be==="vertical"?1:void 0},pagination:ne?{showTotal:(n,o)=>t({en:`Showing ${o[0]}-${o[1]} / Total ${n}`,vi:`Hiển thị ${o[0]}-${o[1]} / Tổng ${n}`}),defaultPageSize:$e,showSizeChanger:!0,position:"bottom",align:"center"}:!1,dataSource:Ae,renderItem:Fe,rowKey:u,loadMore:R&&!ne?e.jsx(A,{style:{display:"flex",justifyContent:"center"},children:e.jsx("i",{className:"fas fa-spinner fa-pulse fa-lg"})}):null})]})}export{gt as C,nt as D};
