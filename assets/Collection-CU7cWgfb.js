import{r as x,an as e,ao as C}from"./index-Ch3SQZYM.js";import{u as Re,a as Oe}from"./index-B6CxwFCm.js";import{f as Ve}from"./file-download-oYh-7Uq5.js";import{S as z}from"./sweetalert2.all-BrOwh365.js";import{u as We,a as qe,b as $,t as xe,p as ze,a8 as me,S as A,T as je,a9 as Ge,aa as Je,ab as Xe,ac as Qe}from"./MyApp-BxasvTfg.js";import{D as Ye}from"./index-DwZMrCFQ.js";import{C as Ze}from"./index-CE1W9nXU.js";import{I as Ue}from"./index-CYv9_VMY.js";import{L as Ke}from"./index-CM6-1-7e.js";import{D as Ne}from"./index-BeLVDyfe.js";function et(n,G,S){const[f,m]=x.useState(!1);function I({key:j}){j===n&&m(!0)}function F({key:j}){j===n&&(m(!1),S==null||S())}return x.useEffect(()=>(window.addEventListener("keydown",I),window.addEventListener("keyup",F),()=>{window.removeEventListener("keydown",I),window.removeEventListener("keyup",F)}),[]),f}var ye=(n=>(n.File="file",n.Link="link",n.JSON="json",n))(ye||{}),tt=(n=>(n.Grid="grid",n.Vertical="vertical",n))(tt||{});function gt({collectionName:n,renderItem:G,fetchNext:S,rowKey:f,downloadItem:m,getItemCursor:I,initialData:F=[],downloadThreads:j=5,displayType:be="grid",headerButtons:J=()=>null,header:X=()=>null,once:De=!1,all:ke=!1,stop:Ce=!1,showPagination:ne=!1,pageSize:$e=20,searchPlaceholder:Se=()=>({en:"Search",vi:"Tìm kiếm"}),onSearch:T}){const{ti:t}=We(),{message:L,notification:H}=qe(),{isIntersecting:Ie,ref:Le}=Re(),[ie,oe]=x.useState(!1),[Be,se]=$(`Collection.${n}.hasMore`,!0),[l,le]=$(`Collection.${n}.data`,F),[ae,Ee]=$(`Collection.${n}.pageIndex`,1),[E,Me]=$(`Collection.${n}.search`,""),[u,R]=$(`Collection.${n}.selected`,[]),[w,re]=$(`Collection.${n}.selectMode`,!1),[Pe,_e]=$(`Collection.${n}.downloaded`,{});et("Shift",void 0,()=>{m&&re(i=>!i)});const Ae=x.useMemo(()=>!E||!T?l:l.filter(i=>T(E,i)),[l,E,T]);x.useEffect(()=>{let i=l.length,o=Math.ceil(i/20);ae>o&&Ee(o)},[l,ae]),x.useEffect(()=>{l.length||de(!1)},[n]);const O=(!l.length||Ie||ke)&&Be&&!E&&!Ce;Oe(()=>{O&&Y()},1e3),x.useEffect(()=>{O&&Y()},[O]);const de=(i=!1)=>{i&&xe("Collection:reload");const o=i?[]:ze("Collection.data."+n)||[];le(o),Y(o)},Q=x.useRef(!1),Y=async(i=l)=>{if(Q.current)return;Q.current=!0,oe(!0);const o=await S(i);if(console.log(n,o),o!=null&&o.length){const a=me(i,o,f);if(se(!De&&a.length>0),a.length){const y=[...i,...a];le(y)}}else(o==null?void 0:o.length)===0&&se(!1);Q.current=!1,oe(!1)},Fe=(i,o)=>{const a=u.indexOf(i),y=a>=0,v=Pe[f(i)],M={position:"absolute",top:0,left:0,right:0,bottom:0,width:"100%",height:"100%",background:y||v?"#000a":"#0002"};return e.jsxs("div",{style:{position:"relative",flexGrow:1,height:"100%"},children:[o<l.length-1?G(i,o):e.jsx(A,{ref:Le,children:G(i,o)}),w?e.jsx(C,{type:"primary",style:M,className:"scale-on-hover",onClick:()=>{R(y?b=>b.filter(V=>V!==i):b=>[...b,i])},children:y?e.jsx("i",{className:"fa-solid fa-5x",children:a+1}):v?e.jsx("i",{className:"fa-solid fa-check fa-5x"}):e.jsx("i",{className:"fa-solid fa-square  fa-5x",style:{color:"#fff7"}})}):v?e.jsx("div",{style:{...M,display:"flex",justifyContent:"center",alignItems:"center",pointerEvents:"none",background:"#0006"},children:e.jsx("i",{className:"fa-solid fa-check fa-5x",style:{color:"white"}})}):null]},"select_container_"+f(i))},ce=async({fromCursor:i,downloadType:o,startIndex:a=0}={})=>{var we;if(!m)return;const y=await Ge();if(!("showDirectoryPicker"in window)&&o==="file")return z.fire({icon:"error",title:t({en:"Browser not supported",vi:"Trình duyệt không hỗ trợ"}),text:t({en:"File saver API not supported in this browser. Please use newest version of Edge or Chrome. (window.showDirectoryPicker)",vi:"Trình duyệt này không hỗ trợ API lưu file (window.showDirectoryPicker). Vui lòng sử dụng Edge hoặc Chrome bản mới nhất"})});let v;if(!i&&!w&&(v=await z.fire({icon:"question",title:t({en:"Download",vi:"Tải xuống"})+"?",text:n,showDenyButton:!0,showCancelButton:!1,confirmButtonColor:"#d33",denyButtonColor:"#1668dc",confirmButtonText:t({en:"Download from cursor",vi:"Tiếp tục tải"}),denyButtonText:t({en:"Download all",vi:"Tải từ đầu"})}),v.isDismissed))return;if(v!=null&&v.isConfirmed){const s=await z.fire({icon:"info",title:t({en:"Download from cursor",vi:"Tiếp tục tải"}),html:`
                <label for="from-cursor">
                ${t({en:"Last cursor",vi:"Con trỏ cuối"})}: (${t({en:"leave empty to re-download all",vi:"bỏ trống để tải từ đầu"})})
                </label><br/>
                <input
                    id="from-cursor"
                    class="swal2-input"
                    style="margin: 5px"
                    value="${i||localStorage.getItem(n+"_fromCursor")||""}">
                <br/>
                <label for="start-index">
                ${t({en:"Last index",vi:"Vị trí cuối"})}: (${t({en:"for auto generate file name",vi:"để tự động tạo tên file"})})
                </label><br/>
                <input
                    id="start-index"
                    class="swal2-input"
                    style="margin: 5px"
                    value="${a||localStorage.getItem(n+"_startIndex")||0}">
            `,preConfirm:()=>{var d,_;return[(d=document.getElementById("from-cursor"))==null?void 0:d.value,(_=document.getElementById("start-index"))==null?void 0:_.value]},showCancelButton:!0,confirmButtonText:t({en:"Start download",vi:"Bắt đầu tải"})});if(s.isDismissed||s.isDenied)return;i=s.value[0],a=parseInt(((we=s.value)==null?void 0:we[1])||0)}if(!o){const s=await z.fire({icon:"question",title:t({en:"Data type",vi:"Loại dữ liệu"}),html:`
                    <label for="download-type">
                        ${t({en:"Which data type you want to download?",vi:"Bạn muốn tải xuống loại dữ liệu nào?"})}
                    </label><br/>
                    <select
                        id="download-type"
                        class="swal2-select"
                        style="margin: 5px">
                        ${Object.values(ye).map(d=>`<option value="${d}">${d}</option>`).join("")}
                    </select>
                `,preConfirm:()=>{var d;return(d=document.getElementById("download-type"))==null?void 0:d.value},showCancelButton:!0,reverseButtons:!0});if(s.isDismissed)return;o=s.value}xe("downloadCollection:"+o+":"+(w?`selected:${u.length}:`:"all:")+n);let M;if(o==="file"){const s=await window.showDirectoryPicker({mode:"readwrite"});await s.requestPermission({writable:!0}),M=await s.getDirectoryHandle(n,{create:!0})}const b="downloading_collection_"+n,V="stopping_downloading_collection_"+n;L.loading({key:b,content:t({en:"Downloading",vi:"Đang tải"})+"...",duration:0});const D=i?[]:w?[...u]:[...l];let Z=0,U=0,W=0,P=0,h=0,K=!0,p=!1,fe=!1,ue=!0,he=[],ge=[];for(;!p&&ue;){if(!w&&h>=D.length-j-1){const B=await S(D,K?i:void 0),r=me(D,B,f);!(r!=null&&r.length)&&K&&i&&H.open({type:"error",message:t({en:"No data at from your cursor",vi:"Không có dữ liệu tại vị trí bạn nhập"})+i+" ("+n+")",description:t({en:"Will download from start",vi:"Sẽ tải từ đầu"}),duration:0}),K=!1,console.log(r),r!=null&&r.length?D.push(...r):ue=!1}const s=D.slice(h,h+j);if(!s.length)break;const d=Math.min(j,s.length),_=Array.from({length:d},()=>"");await Promise.all(s.map(async(B,r)=>{try{let c=await m(B,Z);Array.isArray(c)||(c=[c]);let ve=!1;for(let g=0;g<c.length&&!p;g++){const{url:k,name:He}=c[g];if(!k)continue;const N=a+h+r+"_"+g+"_"+He;if(c[g].name=N,_[r]="thread "+(r+1)+": item "+(Z+r+1)+(c.length>1?` (${g+1}/${c.length})`:""),!p&&!fe&&L.loading({key:b,content:e.jsxs("span",{children:[`${t({en:"Downloading",vi:"Đang tải"})}... ${U}`,W?e.jsxs(e.Fragment,{children:[t({en:"Failed",vi:"Lỗi"}),": $",W," ",e.jsx("br",{})]}):"",e.jsx("br",{}),n,e.jsx("br",{}),e.jsx("i",{children:t({en:"Click to stop",vi:"Bấm để dừng"})}),e.jsx("br",{}),e.jsx(Ne,{}),_.map((ee,te)=>e.jsxs("span",{style:{width:"100%",textAlign:"left",display:"block"},children:[ee,e.jsx("br",{})]},te)),e.jsx("br",{})]}),duration:0,onClick:()=>{p=!0,L.loading({key:V,content:t({en:"Stopping...",vi:"Đang dừng..."}),duration:0})}}),ge.push(k),o==="file")try{const te=await(await Je({url:k,checkAbortFn:()=>p})).blob(),pe=await(await M.getFileHandle(N,{create:!0})).createWritable();await pe.write(te),await pe.close()}catch{p||(y?(await Xe({url:k,conflictAction:"overwrite",filename:n+"/"+N}),ve=!0):(W++,H.open({type:"error",message:t({en:"Download failed",vi:"Lỗi tải"}),description:k})))}U++}ve&&P++,Z++,he.push({data:c,raw:B}),_e(g=>({...g,[f(B)]:!0})),R(g=>g.filter(k=>f(k)!==f(B)))}catch(c){W++,L.error({content:t({en:"Download failed",vi:"Lỗi tải"})+": "+c.message})}})),p||(h+=s.length)}if(fe=!0,o==="json"||o==="link"){const s=n+(o==="json"?".json":".txt"),d=o==="json"?JSON.stringify(he,null,4):ge.join(`
`);Ve(d,s)}let q="";try{q=(I==null?void 0:I(D[h]||D[h-1]))||""}catch(s){console.error(s)}L.destroy(b),L.destroy(V),P>0&&H.open({type:"info",message:t({en:"In Download/ folder",vi:"Trong folder Download/"})+": "+P,description:t({en:"Files that cannot be normal downloaded, will be force download into default Download folder of your browser",vi:"Những file không thể tải bình thường, sẽ được tải vào trong folder Download/ mặc định của trình duyệt"}),duration:0,btn:e.jsx(C,{onClick:Qe,children:t({en:"Show Download/ folder",vi:"Mở folder Download/"})})}),H.open({type:"success",message:t(p?{en:"Download stopped",vi:"Đã dừng tải"}:{en:"Download finished",vi:"Tải xong"}),description:e.jsxs("ul",{children:[e.jsx("li",{children:t({en:"Folder name",vi:"Tên folder"})+": "+n}),e.jsx("li",{children:t({en:"Downloaded",vi:"Đã tải"})+": "+U}),P>0&&e.jsx("li",{children:t({en:"In Download/ folder",vi:"Trong folder Download/"})+": "+P}),e.jsx("li",{children:t({en:"Last index",vi:"Vị trí cuối"})+": "+(h+a)}),e.jsx("li",{children:t({en:"Last cursor",vi:"Con trỏ cuối"})+": "+q})]}),duration:0,btn:e.jsx(A,{direction:"horizontal",children:p&&!w?e.jsx(C,{onClick:()=>ce({downloadType:o,fromCursor:q,startIndex:h+a}),children:t({en:"Continue download",vi:"Tiếp tục tải"})}):null})}),localStorage.setItem(n+"_fromCursor",q+""),localStorage.setItem(n+"_startIndex",h+a+"")},Te=m&&l.length>0;return e.jsxs(A,{direction:"vertical",align:"center",style:{width:"100%"},children:[X==null?void 0:X(l),e.jsxs(C.Group,{style:{width:"100%",justifyContent:"center"},children:[e.jsx(C,{onClick:()=>de(!0),icon:e.jsx("i",{className:"fa-solid fa-rotate-right"}),disabled:ie,loading:ie,children:t({en:"Refresh",vi:"Làm mới"})}),Te&&e.jsx(Ye,{menu:{items:[{key:"selectMode",label:e.jsxs(A,{align:"center",children:[e.jsxs(je,{title:t({en:"Shortcut: press Shift",vi:"Phím tắt: ấn Shift"}),children:[e.jsx(Ze,{checked:w})," ",t({en:"Select mode",vi:"Chọn để tải"})]}),(u==null?void 0:u.length)>0&&e.jsx(je,{title:t({en:"Clear selected",vi:"Xoá lựa chọn"}),children:e.jsx(C,{onClick:()=>R([]),icon:e.jsx("i",{className:"fa-solid fa-trash"}),children:u==null?void 0:u.length})})]})},{key:"file",label:t({en:"Download files",vi:"Tải files"})},{key:"link",label:t({en:"Download links",vi:"Tải links"})},{key:"json",label:t({en:"Download .json",vi:"Tải .json"})}],onClick:i=>{i.key==="selectMode"?re(!w):ce({downloadType:i.key})}},children:e.jsx(C,{type:"primary",icon:e.jsx("i",{className:"fa-solid fa-download"}),children:t({en:"Download",vi:"Tải xuống"})+(w?` (${u.length})`:t({en:" all",vi:" tất cả"}))})}),J==null?void 0:J(l)]}),T&&e.jsx(Ue.Search,{value:E,onChange:i=>Me(i.target.value+""),placeholder:t(Se(l)),allowClear:!0,style:{minWidth:300}}),e.jsx(Ke,{grid:{gutter:10,column:be==="vertical"?1:void 0},pagination:ne?{showTotal:(i,o)=>t({en:`Showing ${o[0]}-${o[1]} / Total ${i}`,vi:`Hiển thị ${o[0]}-${o[1]} / Tổng ${i}`}),defaultPageSize:$e,showSizeChanger:!0,position:"bottom",align:"center"}:!1,dataSource:Ae,renderItem:Fe,rowKey:f,loadMore:O&&!ne?e.jsx(A,{style:{display:"flex",justifyContent:"center"},children:e.jsx("i",{className:"fas fa-spinner fa-pulse fa-lg"})}):null})]})}export{gt as C,tt as D};
